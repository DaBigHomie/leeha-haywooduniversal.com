name: 'Agent: Code Review'

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    name: Haywood Universal Code Review
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript Check
        id: typescript
        continue-on-error: true
        run: |
          if npx tsc --noEmit 2>&1; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi

      - name: Run ESLint
        id: eslint
        continue-on-error: true
        run: |
          if npm run lint 2>&1; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi

      - name: Run Build
        id: build
        continue-on-error: true
        run: |
          if npm run build 2>&1; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi

      - name: Check Atlanta Keywords
        id: keywords
        run: |
          # Search for Atlanta-specific cultural keywords in changed files
          KEYWORDS="Metro Atlanta|Atlanta|Buckhead|Midtown|Prosperity|Success|Wealth|Investment|Community|Professional"
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD -- '*.tsx' '*.ts' '*.mdx' '*.md' || true)
          
          if [ -n "$CHANGED_FILES" ]; then
            KEYWORD_COUNT=$(echo "$CHANGED_FILES" | xargs grep -E "$KEYWORDS" 2>/dev/null | wc -l || echo "0")
            echo "keyword_count=$KEYWORD_COUNT" >> $GITHUB_OUTPUT
            
            if [ "$KEYWORD_COUNT" -ge 2 ]; then
              echo "status=pass" >> $GITHUB_OUTPUT
            else
              echo "status=warn" >> $GITHUB_OUTPUT
            fi
          else
            echo "keyword_count=0" >> $GITHUB_OUTPUT
            echo "status=skip" >> $GITHUB_OUTPUT
          fi

      - name: Check for Avoid Terms
        id: avoid_terms
        run: |
          AVOID_TERMS="lorem ipsum|click here|placeholder|coming soon"
          
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD -- '*.tsx' '*.ts' '*.mdx' '*.md' || true)
          
          if [ -n "$CHANGED_FILES" ]; then
            FOUND=$(echo "$CHANGED_FILES" | xargs grep -iE "$AVOID_TERMS" 2>/dev/null | wc -l || echo "0")
            echo "found=$FOUND" >> $GITHUB_OUTPUT
            
            if [ "$FOUND" -eq 0 ]; then
              echo "status=pass" >> $GITHUB_OUTPUT
            else
              echo "status=fail" >> $GITHUB_OUTPUT
            fi
          else
            echo "found=0" >> $GITHUB_OUTPUT
            echo "status=skip" >> $GITHUB_OUTPUT
          fi

      - name: Generate Review Summary
        id: summary
        run: |
          # Calculate overall score
          SCORE=10
          
          if [ "${{ steps.typescript.outputs.status }}" = "fail" ]; then
            SCORE=$((SCORE - 3))
          fi
          
          if [ "${{ steps.eslint.outputs.status }}" = "fail" ]; then
            SCORE=$((SCORE - 2))
          fi
          
          if [ "${{ steps.build.outputs.status }}" = "fail" ]; then
            SCORE=$((SCORE - 3))
          fi
          
          if [ "${{ steps.avoid_terms.outputs.status }}" = "fail" ]; then
            SCORE=$((SCORE - 1))
          fi
          
          if [ "${{ steps.keywords.outputs.status }}" = "warn" ]; then
            SCORE=$((SCORE - 1))
          fi
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          
          if [ "$SCORE" -ge 9 ]; then
            echo "recommendation=approve" >> $GITHUB_OUTPUT
          elif [ "$SCORE" -ge 7 ]; then
            echo "recommendation=approve_with_comments" >> $GITHUB_OUTPUT
          else
            echo "recommendation=request_changes" >> $GITHUB_OUTPUT
          fi

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const tsStatus = '${{ steps.typescript.outputs.status }}';
            const eslintStatus = '${{ steps.eslint.outputs.status }}';
            const buildStatus = '${{ steps.build.outputs.status }}';
            const keywordsStatus = '${{ steps.keywords.outputs.status }}';
            const keywordCount = '${{ steps.keywords.outputs.keyword_count }}';
            const avoidStatus = '${{ steps.avoid_terms.outputs.status }}';
            const avoidFound = '${{ steps.avoid_terms.outputs.found }}';
            const score = '${{ steps.summary.outputs.score }}';
            const recommendation = '${{ steps.summary.outputs.recommendation }}';
            
            const statusIcon = (status) => {
              switch(status) {
                case 'pass': return 'âœ…';
                case 'fail': return 'âŒ';
                case 'warn': return 'âš ï¸';
                case 'skip': return 'â­ï¸';
                default: return 'â“';
              }
            };
            
            const body = `## ðŸ¤– Haywood Universal Code Review

### Automated Checks

| Check | Status | Details |
|-------|--------|---------|
| TypeScript Compilation | ${statusIcon(tsStatus)} ${tsStatus.toUpperCase()} | Type checking |
| ESLint | ${statusIcon(eslintStatus)} ${eslintStatus.toUpperCase()} | Code quality |
| Production Build | ${statusIcon(buildStatus)} ${buildStatus.toUpperCase()} | Build verification |
| Atlanta Keywords | ${statusIcon(keywordsStatus)} ${keywordsStatus.toUpperCase()} | Found ${keywordCount} cultural keywords |
| Avoid Terms | ${statusIcon(avoidStatus)} ${avoidStatus.toUpperCase()} | Found ${avoidFound} terms to avoid |

### Overall Score: ${score}/10

**Recommendation**: ${recommendation === 'approve' ? 'âœ… APPROVE' : recommendation === 'approve_with_comments' ? 'âš ï¸ APPROVE WITH COMMENTS' : 'âŒ REQUEST CHANGES'}

---

### Checklist for Haywood Universal

- [ ] Design system colors used (Primary: #C9A86A, Secondary: #1B365D)
- [ ] Responsive design (mobile-first)
- [ ] Accessibility (ARIA labels, keyboard navigation)
- [ ] Atlanta-specific content where relevant
- [ ] No placeholder content

---
*Automated review by UGWTF Code Review Agent v2.0*
*Project: Haywood Universal LLC - Metro Atlanta Multi-Service Platform*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Auto-Approve if Score >= 9
        if: steps.summary.outputs.score >= 9
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'âœ… Auto-approved by UGWTF Code Review Agent (Score: ${{ steps.summary.outputs.score }}/10)'
            });
